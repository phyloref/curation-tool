<!doctype html>
<html lang="en">

<!--
    Phyloreferencing Curation Tool
    Copyright (c) The Phyloreferencing Project, 2018.

    Skeleton based on https://www.taniarascia.com/basic-html5-file/
-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-size=1">

    <title>Phyloref Curation Tool</title>

    <!--
    <link rel="icon" href="images/favicon.png">
    -->

    <!-- Load stylesheets and IE8 support -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="./lib/phylotree.js/phylotree.css">
    <link rel="stylesheet" href="./css/main.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body @unload="closeCurrentStudy()">

    <!-- Vue.js will execute on this element and its children -->
    <div id="app">
      <!-- Navigation bar at the top of the page -->
      <nav class="navbar navbar-default">
        <div class="container-fluid">
          <div class="navbar-header">
            <a class="navbar-brand" href="index.html">Curation Tool v{{CURATION_TOOL_VERSION}}</a>
          </div>
          <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav navbar-right">
              <li><a href="#" onclick="$('#about-curation-tool').modal()">About us</a></li>
              <li><a href="https://www.phyloref.org/">Phyloreferencing website</a></li>
              <li><a href="https://github.com/phyloref/curation-tool">Github repository</a></li>
              <li><a href="https://github.com/phyloref/curation-tool/issues">Report bug</a></li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Taxonomic unit editing modal: dialog box to allow editing lists of taxonomic units -->
      <div id="about-curation-tool" class="modal fade">
        <div class="modal-dialog modal-lg form-horizontal">
          <div class="modal-content">
            <!-- Header of tunit editor modal dialog box -->
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title">About the Phyloreferencing Curation Tool</h4>
            </div>

            <!-- Body of specifier editor modal dialog box -->
            <div class="modal-body col-md-12">
              <p>The Phyloreferencing Curation Tool was built as part of the NSF-funding
              <a href="https://www.phyloref.org">Phyloreferencing project</a>.
              </p>
            </div>

            <!-- Footer of the specifier editor modal dialog box -->
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal" @click="closeTUnitEditorModal()">Close</button>
            </div>
          </div>
        </div>
      </div>

        <div class="col-md-12 panel">
            <!-- Menu for loading and exporting files -->
            <div class="btn-group btn-group-justified" role="group" aria-label="Options to load or save testcase">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Load an example <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                        <li v-for="example of examplePHYXURLs">
                            <a href="#" @click="loadPHYXFromURL(example.url)">{{example.title}}</a>
                        </li>
                    </ul>
                </div>

                <label class="btn btn-info btn-group" for="file-input" role="group">
                    <input id="file-input" type="file" style="display:none;" @change="loadPHYXFromFileInputById('#file-input')">
                    Read from local JSON file
                </label>

                <div class="btn-group" role="group">
                    <button id="display-as-json-btn" type="button" class="btn btn-success" onclick="$('#display-as-json').toggle(300)">Display as JSON</button>
                </div>

                <div class="btn-group" role="group">
                    <button id="download-as-jsonld-btn" type="button" class="btn btn-info" @click="downloadAsJSONLD()">Download as JSON-LD</button>
                </div>
            </div>
        </div>

        <!-- Displays the test case as a JSON document -->
        <div id="display-as-json" class="col-md-12" hidden>
            <div class="panel panel-success">
                <div class="panel-heading">Test case as JSON</div>
                <div class="panel-body">
                    <p>The following is a representation of this PHYX in JSON. You
                    can edit the JSON directly, or copy it elsewhere to save it.</p>
                    <textarea id="test-content" cols="80" rows="10" v-model="phyxAsJSON"></textarea>
                </div>
            </div>
        </div>

        <!-- Metadata for the entire study -->
        <form id="study-metadata" class="form-horizontal col-md-12">
            <div id="study-metadata" class="panel panel-info">
                <div class="panel-heading">
                  <!-- Minimize button for panel -->
                  <a href="#" class="close glyphicon glyphicon-collapse-up" onclick="vm.toggleButtonAndPanel(this, $('#study-metadata .panel-body'));"></a>
                  Study metadata
                </div>
                <div class="form-group panel-body">
                    <label for="title" class="col-md-1 control-label">Title</label>
                    <div class="col-md-10 input-group">
                        <input id="title" type="text" class="form-control" v-model.trim="testcase.title" placeholder="Enter study title">
                    </div>

                    <label for="citation" class="col-md-1 control-label">Citation</label>
                    <div class="col-md-10 input-group">
                        <input id="citation" type="text" class="form-control" v-model.trim="testcase.citation" placeholder="Enter citation">
                    </div>

                    <label for="url" class="col-md-1 control-label">URL</label>
                    <div class="col-md-10 input-group">
                        <input id="url" type="url" class="form-control" v-model.trim="testcase['url']" placeholder="Enter URI/URL">
                        <span class="input-group-btn">
                        <button class="btn btn-default" type="button" @click="openURL(testcase.url, '_blank')">Open in new window</button>
                    </span>
                    </div>

                    <label for="doi" class="col-md-1 control-label">DOI</label>
                    <div class="col-md-10 input-group">
                        <span class="input-group-addon">{{DOI_PREFIX}}</span>
                        <input id="doi" type="text" class="form-control" v-model.trim="doiWithoutPrefix" placeholder="Enter DOI">
                        <span class="input-group-btn">
                            <button class="btn btn-default" type="button" @click="openURL(doiAsURL, '_blank')">Open in new window</button>
                    </span>
                    </div>
                </div>
            </div>
        </form>

        <!-- Dropdown menus for navigating phylogenies and phyloreferences -->
        <div class="col-md-12 panel">
            <div class="btn-group btn-group-justified" role="group" aria-label="Options to navigate phylogenies">

                <!-- List of phylogenies -->
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        {{ testcase.phylogenies.length }} phylogenies <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                        <template v-for="(phylogeny, phylogenyIndex) of testcase.phylogenies">
                            <li><a :href="'#phylogeny-' + phylogenyIndex">
                                <template v-if="hasProperty(phylogeny, 'description')">
                                    {{phylogeny['description']}}
                                </template>
                                <template v-else>
                                    Phylogeny {{phylogenyIndex + 1}}
                                </template>
                            </a></li>
                        </template>
                        <li><a href="#phylogeny-footer" @click="testcase.phylogenies.push({})"><strong>Add phylogeny</strong></a></li>
                    </ul>
                </div>

                <!-- List of phyloreferences -->
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        {{ testcase.phylorefs.length }} phyloreferences <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                        <template v-for="(phyloref, phylorefIndex) of testcase.phylorefs">
                            <li :class="{active: selectedPhyloref === phyloref}">
                                <a href="javascript:void(0)" @click="selectedPhyloref = phyloref">{{getPhylorefLabel(phyloref)}}</a>
                            </li>
                        </template>
                        <li><a href="javascript:void(0)" @click="testcase.phylorefs.push(createEmptyPhyloref(testcase.phylorefs.length + 1))"><strong>Add phyloreference</strong></a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Phylogeny display: visualize phylogeny using Phylotree.js and allow its Newick strings to be edited -->
        <div class="col-md-7">
            <div :id="'phylogeny-' + phylogenyIndex" class="panel panel-info" v-for="(phylogeny, phylogenyIndex) of testcase.phylogenies">
                <div class="panel-heading">
                    <!-- Minimize button for panel -->
                    <a href="#" class="close glyphicon glyphicon-collapse-up" onclick="vm.toggleButtonAndPanel(this, $(this).parent().parent().find('.panel-body, .panel-footer'))"></a>

                    <template v-if="phylogenyDescriptionBeingEdited !== phylogeny">
                        <span role="button" @click="phylogenyDescriptionBeingEdited = phylogeny" title="Click to edit">
                            <template v-if="hasProperty(phylogeny, 'description')">
                                {{phylogeny['description']}}
                            </template>
                            <template v-else>
                                Phylogeny {{phylogenyIndex + 1}}
                            </template>
                        </span>
                    </template>
                    <template v-else>
                        <div class="input-group">
                            <input v-model.lazy="phylogeny['description']" type="text" class="form-control" placeholder="Enter a description for this phylogeny, including links">
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="button" @click="phylogenyDescriptionBeingEdited = undefined">Done editing</button>
                            </span>
                        </div>
                    </template>
                </div>
                <div class="panel-body">
                  <template v-if="editingAnnotationsForPhylogeny !== phylogeny">
                    <!-- Display the list of errors encountered when parsing this Newick string -->
                    <template v-for="(error, errorIndex) of getPhylogenyParsingErrors(phylogeny)">
                      <p><strong>{{error.title}}.</strong> {{error.message}}</p>
                    </template>
                    <!-- Display the phylogeny, but only if there are no parsing errors -->
                    <template v-if="getPhylogenyParsingErrors(phylogeny).length === 0">
                      <svg
                        width="100%"
                        :id="'phylogeny-svg-' + phylogenyIndex"
                        :alt="getPhylogenyAsNewick('#phylogeny-svg-' + phylogenyIndex, phylogeny)"></svg>
                    </template>
                  </template>
                  <template v-else>
                        <p>This table displays all labeled nodes in this phylogeny and all known annotations
                        applied to any of those nodes. A feature to change node labels is currently in development.
                        </p>

                        <table class="table table-bordered table-hover table-striped table-fixed-height" style="width: 100%">
                            <tbody>
                                <tr>
                                    <th>Label</th>
                                    <th>Property</th>
                                    <th>Value</th>
                                </tr>
                                <template v-if="getNodeLabelsInPhylogeny(phylogeny).length == 0">
                                    <tr><td style="text-align: center"><em>No labeled nodes in this phylogeny.</em></td></tr>
                                </template>
                                <template
                                    v-else
                                    v-for="(nodeLabel, nodeLabelIndex) of getNodeLabelsInPhylogeny(phylogeny)"
                                >
                                    <template
                                        v-if="hasProperty(phylogeny, 'additionalNodeProperties') && hasProperty(phylogeny.additionalNodeProperties, nodeLabel)"
                                    >
                                        <tr v-for="propName of Object.keys(phylogeny.additionalNodeProperties[nodeLabel])">
                                            <td>{{nodeLabel}}</td>
                                            <td>{{propName}}</td>
                                            <td><textarea readonly rows="4" style="width: 100%">{{JSON.stringify(phylogeny.additionalNodeProperties[nodeLabel][propName])}}</textarea></td>
                                        </tr>
                                    </template>

                                    <template v-else>
                                        <tr>
                                            <td>{{nodeLabel}}</td>
                                            <td colspan="2"><em>No node properties.</em></td>
                                        </tr>
                                    </template>
                                </template>
                            </tbody>
                        </table>

                        <p>This table contains {{getNodeLabelsInPhylogeny(phylogeny).length}} nodes.</p>
                    </template>
                </div>
                <div :id="'phylogeny-' + phylogenyIndex + '-footer'" class="panel-footer">
                    <textarea
                        class="col-md-12"
                        v-if="editingNewickForPhylogeny === phylogeny"
                        placeholder="Enter Newick string for phylogeny here"
                        v-model.lazy="phylogeny.newick"
                        >{{getPhylogenyAsNewick('#phylogeny-svg-' + phylogenyIndex, phylogeny)}}</textarea>
                    <div class="btn-group btn-group-justified" role="group" aria-label="Actions for phylogeny">
                        <!-- Display/hide the Newick editing textarea -->
                        <a :href="'#phylogeny-' + phylogenyIndex + '-footer'" class="btn btn-primary" @click="editingNewickForPhylogeny = (editingNewickForPhylogeny === phylogeny ? undefined : phylogeny)" class="btn btn-default">Edit as Newick</a>

                        <!-- Dropdown button for vertical spacing -->
                        <div class="btn-group" role="group">
                          <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Vertical spacing: {{ phylogenySpacingX[phylogeny] }}px <span class="caret"></span>
                          </button>
                          <ul class="dropdown-menu">
                            <li><a :href="'#phylogeny-' + phylogenyIndex + '-footer'" @click="phylogenySpacingX[phylogeny] += 10">Increase scale</a></li>
                            <li><a :href="'#phylogeny-' + phylogenyIndex + '-footer'" @click="phylogenySpacingX[phylogeny] = (phylogenySpacingX[phylogeny] < 10 ? 0 : phylogenySpacingX[phylogeny] - 10)">Decrease scale</a></li>
                          </ul>
                        </div>

                        <!-- Dropdown button for horizontal spacing -->
                        <div class="btn-group" role="group">
                          <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Horizontal spacing: {{ phylogenySpacingY[phylogeny] }}px <span class="caret"></span>
                          </button>
                          <ul class="dropdown-menu">
                            <li><a :href="'#phylogeny-' + phylogenyIndex + '-footer'" @click="phylogenySpacingY[phylogeny] += 10">Increase scale</a></li>
                            <li><a :href="'#phylogeny-' + phylogenyIndex + '-footer'" @click="phylogenySpacingY[phylogeny] = (phylogenySpacingY[phylogeny] < 10 ? 0 : phylogenySpacingY[phylogeny] - 10)">Decrease scale</a></li>
                          </ul>
                        </div>

                        <!--
                          <a class="btn btn-default" :href="'#phylogeny-' + phylogenyIndex" @click="editingAnnotationsForPhylogeny = (editingAnnotationsForPhylogeny === phylogeny ? undefined : phylogeny)" class="btn btn-default">Edit annotations</a>
                        -->

                        <!-- Button to delete this phylogeny -->
                        <a class="btn btn-danger" :href="'#phylogeny-' + phylogenyIndex" @click="confirm('Are you sure you want to permanently delete this phylogeny?', () => testcase.phylogenies.splice(phylogenyIndex, 1))">Delete phylogeny</a>
                    </div>
                </div>
            </div>

            <!-- A panel for phylogeny-specifier operations -->
            <div id="phylogeny-footer" class="panel panel-default">
                <div class="panel-footer">
                    <div class="btn-group btn-group-justified" role="group" aria-label="Actions for phylogenies">
                        <a href="#phylogeny-footer" @click="testcase.phylogenies.push({})" class="btn btn-default">Add new phylogeny</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Taxonomic unit editing modal: dialog box to allow editing lists of taxonomic units -->
        <div id="tunit-editor-modal" class="modal fade">
            <div class="modal-dialog modal-lg form-horizontal">
                <div class="modal-content" v-if="selectedTUnitListContainer !== undefined">

                    <!-- Header of tunit editor modal dialog box -->
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Editing {{selectedTUnitListContainer.type}} {{selectedTUnitListContainer.label}}</h4>
                    </div>

                    <!-- Body of specifier editor modal dialog box -->
                    <div class="modal-body col-md-12">
                            <form id="tunit-editor-form">
                                <div v-if="selectedTUnitListContainer.type == 'specifier'">
                                    <label for="verbatim-specifier" class="control-label">Verbatim specifier</label>
                                    <input id="verbatim-specifier" type="text" class="form-control" v-model.trim="selectedTUnitListContainer.container['verbatimSpecifier']" placeholder="Enter the verbatim description of this specifier">
                                </div>

                                <!-- List of taxonomic units -->
                                <div id="tunits-panel" class="panel panel-info" style="margin-top: 1em">
                                    <div class="panel-heading">Taxonomic Units</div>
                                    <div class="panel-body" v-if="!selectedTUnit">
                                        <p><em>Select a taxonomic unit or create a new one.</em></p>
                                    </div>
                                    <div class="panel-body" v-if="selectedTUnit">
                                        <p>
                                            Each taxonomic unit can have any number of scientific names, external
                                            references and specimens. We recommend using a single taxonomic unit
                                            for each type of identifier.
                                        </p>

                                        <!-- Panel listing scientific names in this taxonomic unit -->
                                        <div class="col-md-12">
                                            <div class="panel panel-default">
                                                <div class="panel-heading">Scientific names</div>
                                                <div class="panel-body">
                                                    <span v-if="!hasProperty(selectedTUnit, 'scientificNames') || selectedTUnit.scientificNames.length == 0">
                                                        <em>No scientific names provided.</em>
                                                    </span>
                                                    <div class="input-group"
                                                        v-if="hasProperty(selectedTUnit, 'scientificNames')"
                                                        v-for="(scname, scnameIndex) of selectedTUnit.scientificNames">
                                                        <span class="input-group-btn">
                                                            <button type="button" class="btn btn-danger" @click="selectedTUnit.scientificNames.splice(scnameIndex, 1)"><span class="glyphicon glyphicon-remove"></span></button>
                                                        </span>
                                                        <input type="text" class="form-control" v-model.lazy="scname.scientificName">
                                                        <div class="input-group-btn">
                                                            <button type="button"
                                                                class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                                                ><span class="glyphicon glyphicon-search"></span> <span class="caret"></span></button>
                                                            <ul class="dropdown-menu dropdown-menu-right">
                                                                <li class="dropdown-header">Components of the scientific name</li>
                                                                <li><a href="#" onclick="return false"><em>Entered scientific name:</em> {{scname.scientificName}}</a></li>
                                                                <li><a href="#" onclick="return false"><em>Binomial name:</em> {{getBinomialName(scname)}}</a></li>
                                                                <li><a href="#" onclick="return false"><em>Genus:</em> {{getGenus(scname)}}</a></li>
                                                                <li><a href="#" onclick="return false"><em>Specific epithet:</em> {{getSpecificEpithet(scname)}}</a></li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="panel-footer">
                                                    <button type="button" class="btn btn-default"
                                                        @click="createOrAppend(selectedTUnit, 'scientificNames', {'scientificName': ''})"
                                                        >Add a new scientific name</button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Panel listing external references in this taxonomic unit -->
                                        <div class="col-md-6">
                                            <div class="panel panel-default">
                                                <div class="panel-heading">External references</div>
                                                <div class="panel-body">
                                                    <span v-if="!hasProperty(selectedTUnit, 'externalReferences') || selectedTUnit.externalReferences.length == 0">
                                                        <em>No external references provided.</em>
                                                    </span>

                                                    <div class="input-group"
                                                        v-if="hasProperty(selectedTUnit, 'externalReferences')"
                                                        v-for="(externalRef, externalRefIndex) of selectedTUnit.externalReferences">
                                                        <div class="input-group-btn">
                                                            <button type="button" class="btn btn-danger" @click="selectedTUnit.externalReferences.splice(externalRefIndex, 1)"
                                                                ><span class="glyphicon glyphicon-remove"></span></button>
                                                        </div>
                                                        <input type="url" class="form-control" v-model.lazy="selectedTUnit.externalReferences[externalRefIndex]">
                                                        <div class="input-group-btn">
                                                            <button type="button" class="btn btn-primary" @click="openURL(externalRef)">Go to URL</button>
                                                        </div>
                                                    </div>

                                                </div>
                                                <div class="panel-footer">
                                                    <button
                                                        type="button"
                                                        class="btn btn-default"
                                                        style="width: 100%"
                                                        href="#specifier-modal"
                                                        onclick="if(!('externalReferences' in vm.selectedTUnit)) Vue.set(vm.selectedTUnit, 'externalReferences', []); vm.selectedTUnit.externalReferences.push('http://example.org/');"
                                                        >Add a new external reference</button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Panel listing specimens in this taxonomic unit -->
                                        <div class="col-md-6">
                                            <div class="panel panel-default">
                                                <div class="panel-heading">Specimens</div>
                                                <div class="panel-body">
                                                    <span v-if="!hasProperty(selectedTUnit, 'includesSpecimens') || selectedTUnit.includesSpecimens.length == 0">
                                                        <em>No specimens provided.</em>
                                                    </span>
                                                    <div class="input-group"
                                                        v-if="hasProperty(selectedTUnit, 'includesSpecimens')"
                                                        v-for="(specimen, specimenIndex) of selectedTUnit.includesSpecimens">
                                                        <span class="input-group-btn">
                                                            <button type="button" class="btn btn-danger" @click="selectedTUnit.includesSpecimens.splice(scnameIndex, 1)"><span class="glyphicon glyphicon-remove"></span></button>
                                                        </span>
                                                        <input type="text" class="form-control" v-model.lazy="specimen.occurrenceID">
                                                        <div class="input-group-btn">
                                                            <button type="button"
                                                                class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                                                ><span class="glyphicon glyphicon-search"></span> <span class="caret"></span></button>
                                                            <ul class="dropdown-menu dropdown-menu-right">
                                                                <li class="dropdown-header">Specimen components</li>
                                                                <li><a href="#" onclick="return false">Occurrence ID: {{specimen.occurrenceID}}</a></li>
                                                                <li><a href="#" onclick="return false">Institution Code: {{getInstitutionCode(specimen)}}</a></li>
                                                                <li><a href="#" onclick="return false">Collection Code: {{getCollectionCode(specimen)}}</a></li>
                                                                <li><a href="#" onclick="return false">Catalog Number: {{getCatalogNumber(specimen)}}</a></li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="panel-footer">
                                                    <button type="button" class="btn btn-default"
                                                        @click="createOrAppend(selectedTUnit, 'includesSpecimens', {'occurrenceID': ''})"
                                                        >Add a new specimen</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- List of taxonomic units, including the option to add new taxonomic units -->
                                    <div class="list-group">
                                        <a class="list-group-item"
                                            v-for="(tunit, tunitIndex) of selectedTUnitListContainer.list"
                                            :class="{active: selectedTUnit === tunit}"
                                            @click="selectedTUnit = tunit"
                                            :title="getTaxonomicUnitLabel(tunit)"
                                        >{{getTaxonomicUnitLabel(tunit)}}</a>
                                        <a class="list-group-item"
                                            href="javascript: void(0)"
                                            onclick="vm.selectedTUnitListContainer.list.push(vm.createEmptyTaxonomicUnit(vm.selectedTUnitListContainer.list.length + 1))"
                                            ><strong>Add new taxonomic unit</strong></a>
                                    </div>

                                </div>
                            </form>
                    </div>

                    <!-- Footer of the specifier editor modal dialog box -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal" @click="closeTUnitEditorModal()">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phyloreference sidebar: displays phyloreferences and specifiers -->
        <div class="col-md-5 panel float-md-right">
            <div class="panel panel-info">
                <div id="selected-phyloref" class="panel-heading">
                  <!-- Minimize button for panel -->
                  <a href="#" class="close glyphicon glyphicon-collapse-up" onclick="vm.toggleButtonAndPanel(this, $(this).parent().parent().find('.panel-body, .panel-footer, .list-group'))"></a>
                  Phyloreferences
                </div>
                <div v-if="selectedPhyloref" class="panel-body">
                    <form id="phyloref" class="form-horizontal">

                        <!-- Phyloreference label -->
                        <label for="label" class="control-label col-md-3">Label</label>
                        <div class="input-group col-md-9">
                            <input id="label" v-model="selectedPhyloref.label" type="text" class="form-control"  placeholder="Phyloreference label">
                        </div>

                        <!-- Phyloreference clade definition -->
                        <label for="definition" class="control-label col-md-3">Clade definition</label>
                        <div class="input-group col-md-9">
                            <textarea
                                id="definition"
                                v-model.lazy="selectedPhyloref.cladeDefinition"
                                class="form-control"
                                rows="6"
                                placeholder="Phylogenetic clade definition"
                                ></textarea>
                        </div>

                        <!-- Phyloreference curator comments -->
                        <label for="curator-comments" class="control-label col-md-3">Curator comments</label>
                        <div class="input-group col-md-9">
                            <textarea
                                id="curator-comments"
                                v-model.lazy="selectedPhyloref.curatorComments"
                                class="form-control"
                                rows="2"
                                placeholder="Curator notes relating to this phyloreference"
                                ></textarea>
                        </div>

                        <!-- Node(s) this phyloreference is expected to resolve to -->
                        <label for="curator-comments" class="control-label col-md-3">Expected nodes</label>
                        <div class="input-group col-md-9">
                            <!-- What if no phylogenies were loaded? -->
                            <div
                                v-if="testcase['phylogenies'].length == 0"
                            >No phylogenies loaded.</div>

                            <!-- If phylogenies were loaded, we need to display a selector for each phylogeny -->
                            <div class="input-group" v-for="(phylogeny, phylogenyIndex) of testcase['phylogenies']">
                                <!-- Display the phylogeny where this node is expected to match -->
                                <span class="input-group-addon" :title="phylogeny['description']">Phylogeny {{phylogenyIndex + 1}}</span>

                                <!-- Display the matching node(s) -->
                                <template v-if="getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref).length === 0">
                                    <!-- We matched no nodes -->
                                    <input readonly type="text" class="form-control" value="No nodes could be matched">
                                </template>
                                <template v-if="getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref).length === 1">
                                    <!-- We matched exactly one node -->
                                    <input readonly type="text" class="form-control" :value="getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref)[0]">
                                </template>
                                <template v-if="getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref).length > 1">
                                    <!-- We matched more than one node -->
                                    <input readonly type="text" class="form-control" :value="getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref).length + ' nodes matched: ' + getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref).join(', ')">
                                </template>

                                <!-- Display a dropdown menu that allows the modified label to be changed. -->
                                <div class="input-group-btn">
                                    <button
                                        type="button"
                                        class="btn btn-primary dropdown-toggle"
                                        data-toggle="dropdown"
                                        aria-haspopup="true"
                                        aria-expanded="false"
                                        >Change <span class="caret"></span></button>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-right">
                                        <!-- List every labeled node in this phylogeny. -->
                                        <li class="dropdown-header">Labeled internal nodes in this phylogeny</li>
                                        <li
                                            v-for="nodeLabel of getNodeLabelsInPhylogeny(phylogeny, 'internal').sort()"
                                            :class="{active: getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref).includes(nodeLabel)}"
                                        >
                                            <a href="#selected-phyloref" @click="togglePhylorefExpectedNodeLabel(phylogeny, selectedPhyloref, nodeLabel)">{{nodeLabel}}</a>
                                        </li>
                                        <li class="dropdown-header">Labeled terminal nodes in this phylogeny</li>
                                        <li
                                            v-for="nodeLabel of getNodeLabelsInPhylogeny(phylogeny, 'terminal').sort()"
                                            :class="{active: getPhylorefExpectedNodeLabels(phylogeny, selectedPhyloref).includes(nodeLabel)}"
                                        >
                                            <a href="#selected-phyloref" @click="togglePhylorefExpectedNodeLabel(phylogeny, selectedPhyloref, nodeLabel)">{{nodeLabel}}</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Node(s) this phyloreference actually resolved to -->
                        <label for="curator-comments" class="control-label col-md-3">Actual nodes</label>
                        <div class="input-group col-md-9">
                            <!-- What if no phylogenies were loaded? -->
                            <div
                                v-if="testcase['phylogenies'].length == 0"
                            >No phylogenies loaded.</div>

                            <!-- If phylogenies were loaded, we need to display a selector for each phylogeny -->
                            <div class="input-group" v-for="(phylogeny, phylogenyIndex) of testcase['phylogenies']">
                                <!-- Display the phylogeny where this node is expected to match -->
                                <span class="input-group-addon" :title="phylogeny['description']">Phylogeny {{phylogenyIndex + 1}}</span>

                                <!-- Display the matching node(s) -->
                                <template v-if="!hasProperty(reasoningResults, 'phylorefs')">
                                  <input readonly type="text" class="form-control" value="Click 'Reason' to reason over these phyloreferences.">
                                </template>
                                <template v-else>
                                  <template v-if="resolvedNodesForPhylogeny(selectedPhyloref, phylogeny).length === 0">
                                    <!-- We matched no nodes -->
                                    <input readonly type="text" class="form-control" :value="'No nodes could be matched'">
                                  </template>
                                  <template v-if="resolvedNodesForPhylogeny(selectedPhyloref, phylogeny).length === 1">
                                      <!-- We matched exactly one node -->
                                      <input readonly type="text" class="form-control" :value="resolvedNodesForPhylogeny(selectedPhyloref, phylogeny, false)[0]">
                                  </template>
                                  <template v-if="resolvedNodesForPhylogeny(selectedPhyloref, phylogeny).length > 1">
                                      <!-- We matched more than one node -->
                                      <input readonly type="text" class="form-control" :value="resolvedNodesForPhylogeny(selectedPhyloref, phylogeny).length + ' nodes matched: ' + resolvedNodesForPhylogeny(selectedPhyloref, phylogeny, false).join(', ')">
                                  </template>
                                </template>

                                <!-- Display a button that activates reasoning. -->
                                <div class="input-group-btn">
                                    <button
                                        id="reason-over-phylorefs"
                                        type="button"
                                        class="btn btn-primary"
                                        @click="reasonOverPhyloreferences()"
                                        >Reason</button>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- List of specifiers associated with this phyloreference -->
                        <div id="specifiers" class="panel panel-info" style="margin-top: 1em">
                            <div class="panel-heading">Specifiers</div>
                            <div class="panel-body">
                                <div class="input-group"
                                    v-if="selectedPhyloref"
                                    v-for="(specifier, specifierIndex) of getSpecifiers(selectedPhyloref)"
                                    :id="'specifier-' + specifierIndex"
                                >
                                    <!-- Buttons before specifier label -->
                                    <div class="input-group-btn">
                                        <!-- Delete button: initially hidden, made visible by clicking the "Delete some specifiers" button -->
                                        <button v-if="deletingSpecifiersMode" type="button"
                                            class="btn btn-danger"
                                            @click="deleteSpecifier(selectedPhyloref, specifier)"
                                            ><span class="glyphicon glyphicon-remove"></span>
                                        </button>

                                        <!-- Match results with dropdown menu -->
                                        <button
                                            @click="dropdownTargetForSpecifier = 'matchResult'"
                                            type="button" class="btn dropdown-toggle"
                                                :class="{ 'btn-warning': getAllNodeLabelsMatchedBySpecifier(specifier).length == 0, 'btn-success': getAllNodeLabelsMatchedBySpecifier(specifier).length > 0}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <span class="glyphicon"
                                                :class="{ 'glyphicon-asterisk': getAllNodeLabelsMatchedBySpecifier(specifier).length == 0, 'glyphicon-ok': (getAllNodeLabelsMatchedBySpecifier(specifier).length > 0) || hasProperty(specifier, 'specifierWillNotMatch') }"></span>
                                        </button>
                                        <ul v-if="dropdownTargetForSpecifier == 'matchResult'" class="dropdown-menu dropdown-menu-left">
                                            <li class="dropdown-header">Match result</li>
                                            <li v-if="getAllNodeLabelsMatchedBySpecifier(specifier).length == 0">
                                                <a href="#" onclick="return false;"><em>No matches</em></a>
                                            </li>
                                            <li v-for="(nodeLabel, nodeLabelIndex) of getAllNodeLabelsMatchedBySpecifier(specifier)">
                                                <a href="#" onclick="return false;">{{nodeLabel}}</a>
                                            </li>
                                            <template v-if="getAllNodeLabelsMatchedBySpecifier(specifier).length === 0">
                                                <li class="dropdown-header">Specifier will not match</li>
                                                <li><a href="#specifiers"
                                                    @click="promptAndSetDict('Why couldn\'t this specifier be matched?', specifier, 'specifierWillNotMatch')"
                                                    >
                                                        <template v-if="hasProperty(specifier, 'specifierWillNotMatch')">
                                                            Reason <small>(click to edit)</small>: {{specifier.specifierWillNotMatch}}
                                                        </template>
                                                        <template v-else>
                                                            <em>No reason given: click here to set one</em>
                                                        </template>
                                                    </a>
                                                </li>
                                            </template>
                                        </ul>
                                        <ul v-if="dropdownTargetForSpecifier == 'specifierType'" class="dropdown-menu dropdown-menu-left">
                                            <li class="dropdown-header">Specifier type</li>
                                            <li :class="{active: getSpecifierType(selectedPhyloref, specifier) == 'Internal'}">
                                                <a href="#" onclick="return false;"
                                                    @click="setSpecifierType(selectedPhyloref, specifier, 'Internal')"
                                                >Internal specifier</a></li>
                                            <li :class="{active: getSpecifierType(selectedPhyloref, specifier) == 'External'}">
                                                <a href="#" onclick="return false;"
                                                    @click="setSpecifierType(selectedPhyloref, specifier, 'External')"
                                                >External specifier</a></li>
                                        </ul>

                                        <!-- Specifier type with dropdown menu: internal or external specifier -->
                                        <button
                                            @click="dropdownTargetForSpecifier = 'specifierType'"
                                            type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                            > {{getSpecifierType(selectedPhyloref, specifier)}} <span class="caret"></span></button>

                                    </div>

                                    <!-- Specifier label -->
                                    <input type="text" disabled class="form-control" :value="getSpecifierLabel(specifier)" :title="getSpecifierLabel(specifier)">

                                    <!-- Buttons after specifier label: edit button -->
                                    <div class="input-group-btn">
                                        <button type="button" class="btn btn-primary"
                                            @click="startTUnitEditorModal('specifier', getSpecifierLabel(specifier), specifier)"
                                            ><span class="glyphicon glyphicon-edit"></span></button>
                                    </div>
                                </div>
                            </div>

                            <!-- Add or delete specifiers -->
                            <div class="panel-footer">
                                <button
                                    type="button"
                                    class="btn btn-default"
                                    onclick="if(!vm.hasProperty(vm.selectedPhyloref, 'externalSpecifiers')) vm.selectedPhyloref.externalSpecifiers = []; vm.selectedPhyloref.externalSpecifiers.push({});"
                                >Add new specifier</button>
                                <button
                                    type="button"
                                    class="btn btn-default"
                                    @click="deletingSpecifiersMode = !deletingSpecifiersMode"
                                >Delete some specifiers</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="panel-footer" v-if="selectedPhyloref !== undefined && testcase.phylorefs.indexOf(selectedPhyloref) != -1">
                    <div class="btn-group btn-group-justified" role="group" aria-label="Actions for the entire phyloreference">
                        <a
                            href="#selected-phyloref"
                            class="btn btn-default"
                            @click="changeSelectedPhyloref(-1)"
                            >Previous</a>
                        <div class="btn-group" role="group">
                            <button
                                id="phyloref-status"
                                type="button"
                                class="btn btn-primary dropdown-toggle"
                                data-toggle="dropdown"
                                aria-haspopup="true"
                                aria-expanded="false">
                                Status: {{ getPhylorefStatus(selectedPhyloref).statusInEnglish }} <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                              <li><a href="#selected-phyloref" @click="setPhylorefStatus(selectedPhyloref, 'pso:draft')">Draft</a></li>
                              <li><a href="#selected-phyloref" @click="setPhylorefStatus(selectedPhyloref, 'pso:final-draft')">Final draft</a></li>
                              <li><a href="#selected-phyloref" @click="setPhylorefStatus(selectedPhyloref, 'pso:under-review')">Under review</a></li>
                              <li><a href="#selected-phyloref" @click="setPhylorefStatus(selectedPhyloref, 'pso:submitted')">Tested</a></li>
                              <li><a href="#selected-phyloref" @click="setPhylorefStatus(selectedPhyloref, 'pso:published')">Published</a></li>
                              <li><a href="#selected-phyloref" @click="setPhylorefStatus(selectedPhyloref, 'pso:retracted-from-publication')">Retracted</a></li>
                            </ul>
                        </div>
                        <div class="btn-group" role="group">
                            <button
                                id="phyloref-status-changes"
                                type="button"
                                class="btn btn-default dropdown-toggle"
                                data-toggle="dropdown"
                                aria-haspopup="true"
                                aria-expanded="false">
                                {{ getPhylorefStatusChanges(selectedPhyloref).length }} changes <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                              <li><a href="#selected-phyloref" v-for="statusChange of getPhylorefStatusChanges(selectedPhyloref)">
                                {{ statusChange.statusInEnglish }}
                                <div style="font-size: 70%" v-if="hasProperty(statusChange, 'intervalStartAsCalendar')">{{ statusChange.intervalStartAsCalendar }}</div>
                              </a></li>
                            </ul>
                        </div>
                        <a
                            href="#selected-phyloref"
                            class="btn btn-danger"
                            onclick="if(window.confirm('Are you sure you want to delete this phyloreference?')) { vm.testcase.phylorefs.splice(vm.testcase.phylorefs.indexOf(vm.selectedPhyloref), 1); vm.selectedPhyloref = undefined; }"
                            >Delete</a>
                        <a
                            href="#selected-phyloref"
                            class="btn btn-default"
                            @click="changeSelectedPhyloref(+1)"
                            >Next</a>
                    </div>
                </div>

                <!-- List of phyloreferences -->
                <div class="list-group">
                    <a href="#selected-phyloref"
                        class="list-group-item"
                        v-for="(phyloref, phylorefIndex) of testcase.phylorefs"
                        :class="{active: selectedPhyloref === phyloref}"
                        @click="selectedPhyloref = phyloref"
                    >{{hasProperty(phyloref, 'label') ? phyloref.label : 'Phyloreference ' + (phylorefIndex + 1)}}</a>
                    <a class="list-group-item" href="javascript: void(0)" @click="testcase.phylorefs.push(createEmptyPhyloref(testcase.phylorefs.length + 1))"><strong>Add phyloreference</strong></a>
                </div>
            </div>
        </div>
    </div>

    <!-- End of page UI -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"
    ></script>
    <script
        src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"
    ></script>
    <script
        src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.js"
    ></script>

    <!-- Phylotree -->
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="./lib/phylotree.js/phylotree.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" charset="utf-8"></script>

    <!-- Moment: for datetime calculations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>

    <!-- FileSaver.js: for saving generated files to the local hard drive -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>

    <!-- Our source code -->
    <script src="./js/phyx.js"></script>
    <script src="./js/curation-tool.js"></script>

    <!-- Activate window-specific features -->
    <script type="text/javascript"><!--
        $(window).on('beforeunload', (e) => {
            // If someone tries to navigate away from the window while the
            // PHYX has been modified, ask users to confirm before leaving.

            // Confirmation message to display to the user. Note that modern
            // browsers do not display this message, but provide a generic
            // "content has changed" dialog instead.
            var confirmationMessage = 'Your modifications have not been saved and will be lost if you close the Curation Tool. Confirm to discard your changes, or cancel to return to the Curation Tool.';

            if(vm.modified)
                return confirmationMessage;
        });
    //--></script>
</body>

</html>
